<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HonourERD Step-by-step Normalisation </title>
    <link rel="stylesheet" href="./NewSystem.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        .scenario-container {
            background: #faf6d8;
            border: 2px solid #000000; 
            padding: 10px 15px; 
            border-radius: 8px; 
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.08); 
            margin: 10px auto 20px auto; 
            width: 80%; 
            max-width: 900px; 
            font-family: 'Arial', sans-serif;
            text-align: left;
            line-height: 1.5; 
        }
        
        
        .scenario-container h2 {
            font-size: 18px;
            font-weight: bold;
            color: #000000; 
            margin-bottom: 8px;
        }
        
        
        .scenario-intro {
            font-size: 14.5px;
            color: #000000;
            margin-bottom: 8px;
        }
        
      
        .points {
            list-style: none;
            padding-left: 0;
            font-size: 14px;
        }
        
        .solution-text{
            font-size: 14px;
        }
        .issue-list li {
            padding: 0; 
            font-weight: normal;
            display: flex;
            align-items: center;
        }
        
        
        .issue-list li strong {
            color: #c0392b; 
        }
        
     
        .task-text {
            font-size: 14px;
            font-weight: bold;
            color: #000000;
            margin-top: 10px;
        }


        .subprocess-box,
        .step-container {
            background-color: white;
            border: 2px solid #0c0900;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            min-height: 250px;
        }

        .highlight-issue {
            color: red;
            font-weight: bold;
        }

        .highlight-fixed {
            color: green;
            font-weight: bold;
        }

       
        .issue {
            fill: red;
            stroke: black;
        }

        .fixed {
            fill: green;
            stroke: black;
        }

        .highlight-issue {
            color: red;
            font-weight: bold;
        }

        .highlight-fixed {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>HonourERD</h1>

    <div class="scenario-container">
        <h2>Scenario: <span class="highlight">University Enrollment Chaos</span></h2>
        <p class="scenario-intro">
            EduFlex University is struggling with a disorganized student records system. Right now, all student registrations, courses, faculty details, and grades are crammed into a single, messy table, leading to:
        </p>
    
        <ul class="issue-list">
            <li class="points"> <strong>Duplicate students:</strong> Students appear multiple times if they enroll in different courses.</li>
            <li class="points"> <strong>Course confusion: </strong> "Intro to Computing" vs. "Introduction to Computing" vs. "COMP101" make reports unreliable.</li>
            <li class="points"><strong>Grading errors:</strong> Some students have multiple grades recorded for the same course.</li>
            <li class="points"><strong>Administrative delays:</strong> Finding student history and faculty assignments is painfully slow.</li>
        </ul>
    
        <p class="solution-text">
            Normalise the database step-by-step to fix these issues! (<strong>1NF ‚Üí 2NF ‚Üí 3NF</strong>).
        </p>
    
        <p class="task-text">
            Start by entering raw data below:
        </p>
    </div>
    
    <div id="step-1" class="step-container">
        <h3>Step 1: First Normal Form (1NF)</h3>
        <textarea id="input-1nf" placeholder="Enter attributes for UNF (comma-separated)"></textarea>
        <button id="btn-validate-1nf">Process UNF</button>
        <div id="feedback-1nf"></div>
    </div>

    <hr>

    <div class="step-container">
        <h3>Subprocesses of Achieving 1NF</h3>

        <div class="subprocess-box1">
            <h4>Step 1. Ensure Atomicity</h4>

            <div id="atomicity-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p>‚úÖ Atomicity fixes will appear here.</p>
            </div>

            <button id="btn-fix-atomicity">Apply Fix for Atomicity</button>
            <div id="after-atomicity" class="mermaid"></div>
        </div>

        <div class="subprocess-box1" id="repeating-groups-explanation">
            <h4>Step 2. Eliminate Repeating Groups</h4>

    
            <div id="repeating-groups-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p>‚úÖ Feedback on repeating groups will appear here.</p>
            </div>

            <button id="btn-fix-repeating-groups">Apply Fix for Repeating Groups</button>
            <div id="after-repeating-groups" class="mermaid"></div>
        </div>
    </div>

    <hr>


    <div id="step-2" class="step-container">
        <h3>Step 2: Second Normal Form (2NF)</h3>
        <p id="explanation-2nf">Identifying and removing partial dependencies.</p> 

        <div class="subprocess-box2">
            <h4>Before 2NF</h4>
            <div id="before-2nf-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p id="before-2nf-text">‚úÖ 2NF validation feedback will appear here.</p>
            </div>

            <button id="btn-validate-2nf">Validate 2NF</button>
            <div id="before-2nf" class="mermaid"></div>
        </div>

        <div class="subprocess-box2">
            <h4>After 2NF</h4>
            <div id="after-2nf-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p id="after-2nf-text">‚úÖ Fixes applied during 2NF will be displayed here.</p>
            </div>

            <button id="btn-fix-2nf">Apply Fix for 2NF</button>
            <div id="after-2nf" class="mermaid"></div>
        </div>
    </div>

    <hr>

    <div id="step-3" class="step-container">
        <h3>Step 3: Third Normal Form (3NF)</h3>
        <p id="explanation-3nf">Identifying and removing transitive dependencies.</p>

        <div class="subprocess-box3">
            <h4>Before 3NF</h4>
            <div id="before-3nf-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p id="before-3nf-text">‚úÖ 3NF validation feedback will appear here.</p>
            </div>

            <button id="btn-validate-3nf">Validate 3NF</button>
            <div id="before-3nf" class="mermaid"></div>
        </div>

        <div class="subprocess-box3">
            <h4>After 3NF</h4>
            <div id="after-3nf-feedback" style="background-color: #f0f0f0; padding: 10px; border-left: 4px solid #28a745;">
                <p id="after-3nf-text">‚úÖ Fixes applied during 3NF will be displayed here.</p>
            </div>

            <button id="btn-fix-3nf">Apply Fix for 3NF</button>
            <div id="after-3nf" class="mermaid"></div>
        </div>
    </div>

    <hr>

  
    <div id="final-summary-container" class="step-container" style="display:none;">
        <h3>Final Normalised Database</h3>
        <p id="final-summary-text">Here‚Äôs what the database looks like after full normalisation.</p>
        <button id="btn-generate-summary">Generate Final Summary</button>
        <div id="final-summary-diagram" class="mermaid"></div> 
    </div>
    

    <button onclick="goToNext()">Next</button>

    <script>
 





mermaid.initialize({ startOnLoad: false });

function formatFeedback(message) {
    if (message.includes("‚ö†Ô∏è")) {
        return message.replace("‚ö†Ô∏è", `<span style="color: red; font-weight: bold;">‚ö†Ô∏è</span>`);
    }
    if (message.includes("üí°")) {
        return message.replace("üí°", `<span style="color: #ff9800; font-weight: bold;">üí°</span>`);
    }
    if (message.includes("‚úÖ")) {
        return message.replace("‚úÖ", `<span style="color: green; font-weight: bold;">‚úÖ</span>`);
    }
    if (message.includes("‚ùå")) {
        return message.replace("‚ùå", `<span style="color: darkred; font-weight: bold;">‚ùå</span>`);
    }
    return message;
}


let feedbackMessages = {
    "1NF": {
        "atomicityFixed": "‚úÖ Atomicity ensured! (e.g. StudentName ‚Üí StudentFirstName + StudentLastName)",
        "noRepeatingGroups": "‚úÖ No repeating groups detected! No changes were necessary.",
        "repeatingGroupsFixed": "‚ö†Ô∏è Repeating groups detected! GRADE, LECTURERID, ENROLLMENTDATE moved to Enrollment if present."
    },
    "2NF": {
        "partialDependencies": "‚ö†Ô∏è Partial dependencies found! GRADE depends on (StudentID, CourseID), LECTURERID depends on COURSEID, etc.",
        "partialFixApplied": "‚úÖ Partial dependencies fixed! Moved these attributes to Enrollment table.",
        "removeAge": "‚ö†Ô∏è 'AGE' is derived (from DOB). Removing 'AGE' to avoid storing derived data in 2NF.",
        "courseMoved": "‚ö†Ô∏è Course info should be stored separately from students. Moving now.",
        "courseFixApplied": "‚úÖ Course details successfully moved to Course table."
    },
    "3NF": {
        "transitiveDependency": "‚ö†Ô∏è Found transitive dependencies! e.g. 'CREDITS' belongs in Course, also any Lecturer or Course details in the wrong table.",
        "transitiveFixApplied": "‚úÖ Transitive dependencies fixed: 'CREDITS' moved to Course, other details to correct tables."
    }
};


function resetMermaid(selector) {
    setTimeout(() => {
        document.querySelectorAll(selector).forEach(el => el.removeAttribute("data-processed"));
        mermaid.init(undefined, document.querySelector(selector));
    }, 50);
}


function validate1NF() {
    let raw = document.getElementById("input-1nf").value.trim();
    if (!raw) return;

    let attrs = [...new Set(raw.split(",").map(a => a.trim().toUpperCase()))];

    let diagram = `erDiagram\n  UNF {\n`;
    attrs.forEach(a => {
        diagram += `    ${a.replace(/\s+/g, "_")} STRING\n`;
    });
    diagram += `  }\n`;

    document.getElementById("feedback-1nf").innerHTML = `<div class="mermaid">${diagram}</div>`;
    resetMermaid("#feedback-1nf .mermaid");
}

function fixAtomicity() {
    let raw = document.getElementById("input-1nf").value.trim();
    if (!raw) return;

    let attrs = [...new Set(raw.split(",").map(a => a.trim().toUpperCase()))];
    let atomicityFixes = {
        "STUDENTNAME": ["STUDENTFIRSTNAME", "STUDENTLASTNAME"],
        "LECTURERNAME": ["LECTURERFIRSTNAME", "LECTURERLASTNAME"]
    };

    let tables = {
        "Student": new Set(["STUDENTID"]),
        "Lecturer": new Set()
    };

    let feedbackMsgs = [];

    attrs.forEach(a => {
        let up = a.toUpperCase();
        if (atomicityFixes[up]) {
            if (up.includes("STUDENT")) {
                atomicityFixes[up].forEach(x => tables["Student"].add(x));
                feedbackMsgs.push("‚úÖ Split StudentName into StudentFirstName & StudentLastName.");
            } else if (up.includes("LECTURER")) {
                atomicityFixes[up].forEach(x => tables["Lecturer"].add(x));
                feedbackMsgs.push("‚úÖ Split LecturerName into LecturerFirstName & LecturerLastName.");
            }
        }
        else if (up.includes("LECTURER") || up.includes("DEPARTMENT")) {
            tables["Lecturer"].add(up);
        }
        else {
          
            tables["Student"].add(up);
        }
    });

    if (tables["Lecturer"].size === 0) {
        delete tables["Lecturer"];
        feedbackMsgs.push("‚úÖ No lecturer attributes found, removing Lecturer table.");
    }

    document.getElementById("atomicity-feedback").innerHTML = feedbackMsgs.map(formatFeedback).join("<br>");

    let diag = `erDiagram\n`;
    Object.keys(tables).forEach(tbl => {
        diag += `  ${tbl} {\n`;
        tables[tbl].forEach(a => diag += `    ${a.replace(/\s+/g, "_")} STRING\n`);
        diag += `  }\n`;
    });

    document.getElementById("after-atomicity").innerHTML = `<div class="mermaid">${diag}</div>`;
    resetMermaid("#after-atomicity .mermaid");
    window.atomicityFixedTables = structuredClone(tables);
}

function fixRepeatingGroups() {
    let raw = document.getElementById("input-1nf").value.trim();
    if (!raw) return;

    let attrs = [...new Set(raw.split(",").map(a => a.trim().toUpperCase()))];
    let tables = structuredClone(window.atomicityFixedTables || {
        "Student": new Set(["STUDENTID"]),
        "Course": new Set(["COURSEID"])
    });

    if (!tables["Enrollment"]) {
        tables["Enrollment"] = new Set(["STUDENTID", "COURSEID"]);
    }

    if (!tables["Lecturer"] && attrs.includes("LECTURERID")) {
        tables["Lecturer"] = new Set(["LECTURERID"]);
    }

    let repeating = new Set();
    attrs.forEach(a => {
        let up = a.toUpperCase();
       
        if (up === "ENROLLMENTDATE" && tables["Student"].has("ENROLLMENTDATE")) {
            tables["Student"].delete("ENROLLMENTDATE");
            tables["Enrollment"].add("ENROLLMENTDATE");
            repeating.add("ENROLLMENTDATE");
        }
      
        if (up.includes("GRADE") || up.includes("LECTURERID")) {
            repeating.add(up);
        }
    });

    repeating.forEach(r => {
        if (r.includes("GRADE") || r.includes("LECTURERID")) {
            tables["Enrollment"].add(r);
        }
        if (tables["Student"]?.has(r)) {
            tables["Student"].delete(r);
        }
        if (tables["Course"]?.has(r)) {
            tables["Course"].delete(r);
        }
        if (r === "LECTURERID" && tables["Lecturer"]) {
            tables["Lecturer"].add(r);
        }
    });

    let feedbackMsgs = [];
    if (repeating.size > 0) {
        let list = [...repeating].map(x => `<li>${x}</li>`).join("");
        feedbackMsgs.push(`‚úÖ Moved repeating attributes: <ul>${list}</ul> to Enrollment.`);
    } else {
        feedbackMsgs.push("‚úÖ No repeating groups found!");
    }

    document.getElementById("repeating-groups-feedback").innerHTML = feedbackMsgs.map(formatFeedback).join("<br>");

    let diag = `erDiagram\n`;
    Object.keys(tables).forEach(tbl => {
        diag += `  ${tbl} {\n`;
        tables[tbl].forEach(a => diag += `    ${a.replace(/\s+/g, "_")} STRING\n`);
        diag += `  }\n`;
    });

    document.getElementById("after-repeating-groups").innerHTML = `<div class="mermaid">${diag}</div>`;
    resetMermaid("#after-repeating-groups .mermaid");
    window.repeatingGroupsFixedTables = structuredClone(tables);
}


function validate2NF() {
    if (!window.repeatingGroupsFixedTables) return;

    let tables = structuredClone(window.repeatingGroupsFixedTables);
    let feedbackArr = [];

    if (!tables["Enrollment"]) {
        tables["Enrollment"] = new Set(["STUDENTID", "COURSEID"]);
        feedbackArr.push("‚ö†Ô∏è Created missing Enrollment table to handle partial dependencies.");
    }

   
    if (tables["Student"].has("GRADE")) {
        tables["Student"].delete("GRADE");
        tables["Enrollment"].add("GRADE");
        feedbackArr.push("‚úÖ 'GRADE' moved from Student to Enrollment.");
    }

    if (!tables["Lecturer"]) {
        tables["Lecturer"] = new Set(["LECTURERID"]);
    }
    if (tables["Student"].has("LECTURERID")) {
        tables["Student"].delete("LECTURERID");
        tables["Enrollment"].add("LECTURERID");
        tables["Lecturer"].add("LECTURERID");
        feedbackArr.push("‚úÖ 'LECTURERID' moved from Student to Lecturer & Enrollment.");
    }

   
    if (!tables["Course"]) {
        tables["Course"] = new Set(["COURSEID"]);
    }
    if (tables["Student"].has("COURSEID")) {
        tables["Student"].delete("COURSEID");
        tables["Enrollment"].add("COURSEID");
        feedbackArr.push("‚úÖ 'COURSEID' moved from Student to Enrollment.");
    }

  
    if (tables["Student"].has("AGE")) {
        tables["Student"].delete("AGE");
      
        if (!tables["Student"].has("DOB")) {
            tables["Student"].add("DOB");
        }
        feedbackArr.push(feedbackMessages["2NF"].removeAge);
    }

 
    document.getElementById("before-2nf-text").innerHTML = feedbackArr.length
        ? feedbackArr.map(formatFeedback).join("<br>")
        : "‚úÖ No partial dependencies found! Already in 2NF.";

    let diag = `erDiagram\n`;
    for (let t in tables) {
        diag += `  ${t} {\n`;
        tables[t].forEach(a => diag += `    ${a} STRING\n`);
        diag += `  }\n`;
    }

    document.getElementById("before-2nf").innerHTML = `<div class="mermaid">${diag}</div>`;
    resetMermaid("#before-2nf .mermaid");

    window.before2NFTables = structuredClone(tables);
}

function fix2NF() {
    if (!window.before2NFTables) return;

    let tables = structuredClone(window.before2NFTables);
    let feedbackArr = [];

 
    if (!tables["Enrollment"]) {
        tables["Enrollment"] = new Set(["STUDENTID", "COURSEID"]);
    }


    if (tables["Student"].has("GRADE")) {
        tables["Student"].delete("GRADE");
        tables["Enrollment"].add("GRADE");
        feedbackArr.push("‚úÖ Moved 'GRADE' from Student to Enrollment.");
    }


    if (!tables["Lecturer"]) {
        tables["Lecturer"] = new Set(["LECTURERID"]);
    }
    if (tables["Student"].has("LECTURERID")) {
        tables["Student"].delete("LECTURERID");
        tables["Lecturer"].add("LECTURERID");
        tables["Enrollment"].add("LECTURERID");
        feedbackArr.push("‚úÖ Moved 'LECTURERID' from Student to Lecturer & Enrollment.");
    }


    if (!tables["Course"]) {
        tables["Course"] = new Set(["COURSEID"]);
    }
    if (tables["Student"].has("COURSEID")) {
        tables["Student"].delete("COURSEID");
        tables["Enrollment"].add("COURSEID");
        feedbackArr.push("‚úÖ Moved 'COURSEID' from Student to Enrollment.");
    }

    if (tables["Student"].has("AGE")) {
        tables["Student"].delete("AGE");
        if (!tables["Student"].has("DOB")) {
            tables["Student"].add("DOB");
        }
        feedbackArr.push(feedbackMessages["2NF"].removeAge);
    }

    document.getElementById("after-2nf-text").innerHTML = feedbackArr.length
        ? feedbackArr.map(formatFeedback).join("<br>")
        : "‚úÖ No changes needed. DB already in 2NF.";

    let diag = `erDiagram\n`;
    Object.keys(tables).forEach(t => {
        diag += `  ${t} {\n`;
        tables[t].forEach(a => diag += `    ${a} STRING\n`);
        diag += `  }\n`;
    });

    document.getElementById("after-2nf").innerHTML = `<div class="mermaid">${diag}</div>`;
    resetMermaid("#after-2nf .mermaid");

    window.finalTables = structuredClone(tables);
}


function validate3NF() {
    console.log("Validating 3NF...");


    if (!window.finalTables) {
        console.error("No final tables from 2NF. Run 'Fix 2NF' first.");
        return;
    }


    let tables = structuredClone(window.finalTables);

  
    let transitiveAttrs = new Set();

    if (!tables["Course"]) {
        tables["Course"] = new Set(["COURSEID"]);
    }

   
    Object.keys(tables).forEach(tbl => {
        tables[tbl].forEach(attr => {
        
            if ((attr === "COURSENAME" || attr === "CREDITS") && tbl !== "Course") {
                transitiveAttrs.add(attr);
            }
         
        });
    });

  
    if (transitiveAttrs.size === 0) {
        document.getElementById("before-3nf-text").innerHTML =
            formatFeedback("‚úÖ No transitive dependencies found! The database is already in 3NF.");
        return;
    }


    let diagramCode = `erDiagram\n  Transitive_Review {\n`;
    transitiveAttrs.forEach(a => {
        diagramCode += `    ${a} STRING\n`;
    });
    diagramCode += `  }\n`;

    document.getElementById("before-3nf").innerHTML = `<div class="mermaid">${diagramCode}</div>`;
    resetMermaid("#before-3nf .mermaid");

 
    let feedbackMsg = "‚ö†Ô∏è Found transitive dependencies! " +
        [...transitiveAttrs].join(", ") + " should be in 'Course' or 'Lecturer' tables.";
    document.getElementById("before-3nf-text").innerHTML = formatFeedback(feedbackMsg);

    window.before3NFTables = structuredClone(tables);
}

function fix3NF() {
    console.log("Fixing 3NF...");


    if (!window.before3NFTables) {
        console.error("No 3NF data to fix. Run Validate 3NF first.");
        return;
    }

    let tables = structuredClone(window.before3NFTables);

 
    if (!tables["Course"]) {
        tables["Course"] = new Set(["COURSEID"]);
    }

  
    let toMove = [];

    Object.keys(tables).forEach(tbl => {
        tables[tbl].forEach(attr => {
            if ((attr === "COURSENAME" || attr === "CREDITS") && tbl !== "Course") {
                toMove.push(attr);
            }
        });
    });

  
    toMove.forEach(a => {
        Object.keys(tables).forEach(tbl => {
            if (tables[tbl].has(a) && tbl !== "Course") {
                tables[tbl].delete(a);
            }
        });
    });

  
    toMove.forEach(a => {
        tables["Course"].add(a);
    });

 
    let feedbackArr = [];
    if (toMove.length > 0) {
        feedbackArr.push("‚úÖ Transitive dependencies fixed: " + toMove.join(", ") + " moved to Course.");
    } else {
        feedbackArr.push("‚úÖ No changes needed, already in 3NF.");
    }

    let diag = `erDiagram\n`;
    Object.keys(tables).forEach(tbl => {
        diag += `  ${tbl} {\n`;
        tables[tbl].forEach(a => {
            diag += `    ${a.replace(/\s+/g, "_")} STRING\n`;
        });
        diag += `  }\n`;
    });

    document.getElementById("after-3nf").innerHTML = `<div class="mermaid">${diag}</div>`;
    document.getElementById("after-3nf-text").innerHTML = feedbackArr.map(formatFeedback).join("<br>");
    resetMermaid("#after-3nf .mermaid");


    window.finalTables = structuredClone(tables);
}


function generateFinalSummaryDiagram() {
    if (!window.finalTables) {
        document.getElementById("final-summary-text").innerHTML =
            "‚ùå Error: Final tables are missing. Ensure you complete all normalisation steps.";
        return;
    }

    let tables = structuredClone(window.finalTables);
    let diag = `erDiagram\n`;

    Object.keys(tables).forEach(t => {
        diag += `  ${t} {\n`;
        tables[t].forEach(a => diag += `    ${a.replace(/\s+/g, "_")} STRING\n`);
        diag += `  }\n`;
    });

    document.getElementById("final-summary-diagram").innerHTML = `<div class="mermaid">${diag}</div>`;
    document.getElementById("final-summary-container").style.display = "block";
    document.getElementById("final-summary-text").innerHTML = "‚úÖ Normalisation Complete! Below is your 3NF structure.";
    resetMermaid("#final-summary-diagram .mermaid");
}


document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("btn-validate-1nf").addEventListener("click", validate1NF);
    document.getElementById("btn-fix-atomicity").addEventListener("click", fixAtomicity);
    document.getElementById("btn-fix-repeating-groups").addEventListener("click", fixRepeatingGroups);

    document.getElementById("btn-validate-2nf").addEventListener("click", validate2NF);
    document.getElementById("btn-fix-2nf").addEventListener("click", fix2NF);

    document.getElementById("btn-validate-3nf").addEventListener("click", validate3NF);
    document.getElementById("btn-fix-3nf").addEventListener("click", fix3NF);

    document.getElementById("btn-generate-summary").addEventListener("click", generateFinalSummaryDiagram);
});

function goToNext() {
    window.location.href = "Store.html";
}


    </script>

</body>
</html>
